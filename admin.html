<!DOCTYPE html>
<html lang="es">
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width,initial-scale=1" />
Â  <title>Admin â€” Registrar Compra (Meta CAPI) v2.0</title>
Â  <style>
Â  Â  body { font-family: Arial, sans-serif; background:#0b0b0b; color:#f2f2f2; display:flex; justify-content:center; padding: 20px 0; }
    /* Estilos ajustados para mÃ¡s campos */
Â  Â  .card { background:#111; padding:20px; border-radius:10px; width:420px; box-shadow:0 8px 30px rgba(0,0,0,0.6); }
Â  Â  input, button { width:100%; padding:10px; margin:8px 0; border-radius:6px; border:1px solid #222; background:#0d0d0d; color:#fff; box-sizing: border-box; }
Â  Â  button { background:#1f8ef1; border:none; font-weight:700; cursor:pointer; }
Â  Â  button:disabled { opacity:0.6; cursor:not-allowed; }
Â  Â  #response { margin-top:10px; white-space:pre-wrap; font-size:0.9rem; word-break: break-all; }
Â  Â  .hint { font-size:0.85rem; color:#9aa; margin-bottom:8px; }
Â  Â  label { font-size:0.85rem; color:#cfd; display:block; margin-top:6px; }
    .section-title { font-size: 0.9rem; color: #00ff88; margin-top: 20px; border-bottom: 1px solid #333; padding-bottom: 5px;}
Â  </style>
</head>
<body>
Â  <div class="card" role="main">
Â  Â  <h2 style="margin:0 0 10px 0;">Registrar Compra â€” CAPI</h2>

Â  Â  <p class="hint">IngresÃ¡ la <strong>clave administrativa</strong> </p>
Â  Â  <label for="adminToken">Clave administrativa</label>
Â  Â  <input id="adminToken" type="password" autocomplete="off" placeholder="token" />

    <h3 class="section-title">Datos del Usuario</h3>
Â  Â  <label for="nombre">Nombre</label>
Â  Â  <input id="nombre" type="text" placeholder="nombre" />

Â  Â  <label for="apellido">Apellido</label>
Â  Â  <input id="apellido" type="text" placeholder="apellido" />

Â  Â  <label for="phone">TelÃ©fono (ej: +5491122334455)</label>
Â  Â  <input id="phone" type="text" placeholder="+5491122334455" />

Â  Â  <label for="amount">Monto en ARS (ej: 26000)</label>
Â  Â  <input id="amount" type="number" placeholder="26000" />

Â  Â  <label for="event_time">Fecha y hora (opcional)</label>
Â  Â  <input id="event_time" type="datetime-local" />

    <h3 class="section-title">Datos de VinculaciÃ³n (EMQ 10/10)</h3>
    <p class="hint">Sacar estos datos del Google Sheet</p>

    <label for="click_id">Click ID (El cÃ³digo corto, ej: A9B3D)</label>
Â  Â  <input id="click_id" type="text" placeholder="A9B3D" />

    <label for="event_id">Event ID (El 'contact-ID', ej: contact-A9B3D)</label>
Â  Â  <input id="event_id" type="text" placeholder="contact-A9B3D" />

    <label for="fbp">FBP (Cookie de Navegador)</label>
Â  Â  <input id="fbp" type="text" placeholder="fb.1.1731269872.1234567890" />

    <label for="fbc">FBC (Cookie de Clic, opcional)</label>
Â  Â  <input id="fbc" type="text" placeholder="fb.1.1731269872.TEST123" />

Â  Â  <button id="sendBtn">Enviar compra a Meta</button>
Â  Â  <div id="response" aria-live="polite"></div>
Â  </div>

Â  <script>
Â  Â  const $ = id => document.getElementById(id);
Â  Â  const sendBtn = $('sendBtn');
Â  Â  const resp = $('response');

Â  Â  function validatePhone(p) {
Â  Â  Â  if (!p) return false;
Â  Â  Â  const cleaned = p.trim();
Â  Â  Â  const digits = cleaned.replace(/\D/g, '');
Â  Â  Â  return digits.length >= 7;
Â  Â  }

Â  Â  async function sendPurchase() {
Â  Â  Â  resp.textContent = '';

      // --- Recolectar TODOS los datos ---
Â  Â  Â  const adminToken = $('adminToken').value.trim();
Â  Â  Â  const nombre = $('nombre').value.trim();
Â  Â  Â  const apellido = $('apellido').value.trim();
Â  Â  Â  const phone = $('phone').value.trim();
Â  Â  Â  const amount = $('amount').value.trim();
Â  Â  Â  const event_time = $('event_time').value;
      
      // --- Nuevos campos de EMQ ---
      const click_id = $('click_id').value.trim();
      const event_id = $('event_id').value.trim();
      const fbp = $('fbp').value.trim();
      const fbc = $('fbc').value.trim();

Â  Â  Â  if (!adminToken) { resp.textContent = 'ðŸ”’ NecesitÃ¡s la clave administrativa.'; return; }
Â  Â  Â  // Validar campos obligatorios
Â  Â  Â  if (!nombre || !apellido || !phone || !amount || !event_id || !fbp) {
Â  Â  Â  Â  resp.textContent = 'âŒ Completa todos los campos obligatorios (Nombre, Apellido, Tel, Monto, Event ID, FBP).';
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  if (!validatePhone(phone)) { resp.textContent = 'âŒ TelÃ©fono invÃ¡lido.'; return; }

Â  Â  Â  sendBtn.disabled = true;
Â  Â  Â  sendBtn.textContent = 'Enviando...';

Â  Â  Â  try {
        // --- Crear el payload completo ---
Â  Â  Â  Â  const payload = { 
          nombre, 
          apellido, 
          phone, 
          amount, 
          event_time,
          click_id, // enviado para logging
          event_id, // enviado para deduplicaciÃ³n
          fbp,      // enviado para EMQ
          fbc       // enviado para EMQ
        };
        
Â  Â  Â  Â  const res = await fetch('/api/meta-purchase', {
Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  'Content-Type': 'application/json',
Â  Â  Â  Â  Â  Â  'Authorization': 'Bearer ' + adminToken
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  body: JSON.stringify(payload)
Â  Â  Â  Â  });

Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  if (res.ok && data.success) {
Â  Â  Â  Â  Â  resp.textContent = 'âœ… Compra enviada correctamente.\n\n' + JSON.stringify(data.metaResponse, null, 2);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  resp.textContent = 'âŒ Error: ' + (data.error || data.message || JSON.stringify(data));
Â  Â  Â  Â  }
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  resp.textContent = 'âŒ Error de red o servidor: ' + e.message;
Â  Â  Â  } finally {
Â  Â  Â  Â  sendBtn.disabled = false;
Â  Â  Â  Â  sendBtn.textContent = 'Enviar compra a Meta';
Â  Â  Â  }
Â  Â  }

Â  Â  sendBtn.addEventListener('click', sendPurchase);

Â  Â  document.addEventListener('keydown', e => {
Â  Â  Â  if (e.key === 'Enter' && !e.target.matches('textarea')) {
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  if (!sendBtn.disabled) sendPurchase();
Â  Â  Â  }
Â  Â  });
Â  </script>
</body>
</html>
